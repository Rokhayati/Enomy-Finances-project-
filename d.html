
<script>
    // Check if user is logged in and update UI accordingly
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user is logged in (either via Flask session or local storage)
        const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true' || localStorage.getItem('isLoggedIn') === 'true';
        
        if (isLoggedIn) {
            // Hide login/signup buttons
            document.getElementById('signup-link').style.display = 'none';
            document.getElementById('login-link').style.display = 'none';
            
            // Show profile icon
            const profileIcon = document.getElementById('profile-icon');
            profileIcon.style.display = 'block';
            
            // Set user data in sidebar and profile modal
            const username = sessionStorage.getItem('username') || localStorage.getItem('username') || 'User';
            const profilePic = sessionStorage.getItem('profilePic') || localStorage.getItem('profilePic');
            const email = sessionStorage.getItem('email') || localStorage.getItem('email') || 'user@example.com';
            const joinedDate = sessionStorage.getItem('joinedDate') || localStorage.getItem('joinedDate') || 'January 2025';
            
            // Set username in sidebar and profile
            document.getElementById('sidebar-username').textContent = username;
            document.getElementById('display-username').value = username;
            document.getElementById('joined-date').value = joinedDate;
            document.getElementById('member-since').textContent = joinedDate;
            
            if (document.getElementById('fullname')) {
                document.getElementById('fullname').value = username;
            }
            
            if (document.getElementById('email')) {
                document.getElementById('email').value = email;
            }
            
            // Set profile picture if available
            if (profilePic && profilePic !== '') {
                const picUrl = profilePic.startsWith('http') ? profilePic : '/uploads/' + profilePic;
                document.getElementById('sidebar-avatar').style.backgroundImage = `url('${picUrl}')`;
                document.getElementById('current-profile-pic').src = picUrl;
                profileIcon.style.backgroundImage = `url('${picUrl}')`;
            }
        }
        
        // Set current year in footer
        document.getElementById('footer-year').textContent = new Date().getFullYear();
    });
    
    // Sidebar toggle functions
    function toggleSidebar() {
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('overlay').classList.add('active');
    }
    
    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('overlay').classList.remove('active');
    }
    
    // Modal functions
    function openModal(modalId) {
        closeSidebar();
        document.getElementById(modalId).classList.add('modal-active');
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('modal-active');
    }
    
    // Chatbot toggle
    document.getElementById('chatbot-toggle').addEventListener('click', function() {
        const chatbotBox = document.getElementById('chatbot-box');
        if (chatbotBox.style.display === 'block') {
            chatbotBox.style.display = 'none';
        } else {
            chatbotBox.style.display = 'block';
            document.getElementById('chatbot-input').focus();
        }
    });
    
    // Chatbot send message
    document.getElementById('chatbot-send').addEventListener('click', sendChatMessage);
    document.getElementById('chatbot-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
    
    function sendChatMessage() {
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const message = chatbotInput.value.trim();
        
        if (message === '') return;
        
        // Add user message
        chatbotMessages.innerHTML += `<p><strong>You:</strong> ${message}</p>`;
        chatbotInput.value = '';
        
        // Scroll to bottom
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        
        // Send message to backend and get response
        fetch('/ask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question: message }),
        })
        .then(response => response.json())
        .then(data => {
            chatbotMessages.innerHTML += `<p><strong>Enomy Bot:</strong> ${data.answer}</p>`;
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        })
        .catch(error => {
            console.error('Error:', error);
            chatbotMessages.innerHTML += `<p><strong>Enomy Bot:</strong> Sorry, I'm having trouble connecting right now. Please try again later.</p>`;
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        });
    }
    
    // Profile picture preview
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                document.getElementById('current-profile-pic').src = e.target.result;
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    // Profile form submission - modified to handle the profile picture upload
    document.getElementById('profile-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/upload-profile-pic', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update profile pictures throughout the interface
                const picUrl = data.imageUrl;
                document.getElementById('profile-icon').style.backgroundImage = `url('${picUrl}')`;
                document.getElementById('sidebar-avatar').style.backgroundImage = `url('${picUrl}')`;
                
                // Store in session and local storage
                sessionStorage.setItem('profilePic', picUrl);
                localStorage.setItem('profilePic', picUrl);
                
                alert('Profile picture updated successfully!');
                closeModal('profile-modal');
            } else {
                alert('Error updating profile picture: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating your profile picture.');
        });
    });
    
    // Function to save settings
    function saveSettings() {
        const fullname = document.getElementById('fullname').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const location = document.getElementById('location').value;
        
        // Store in session and local storage
        sessionStorage.setItem('username', fullname);
        localStorage.setItem('username', fullname);
        sessionStorage.setItem('email', email);
        localStorage.setItem('email', email);
        
        // Update UI elements
        document.getElementById('sidebar-username').textContent = fullname;
        document.getElementById('display-username').value = fullname;
        
        // In a real app, you would send this data to the server
        // For demo purposes, show success message
        alert('Settings saved successfully!');
        closeModal('settings-modal');
    }
    
    // Toggle password visibility
    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.nextElementSibling;
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
    
    // Function to verify current password
    function verifyCurrentPassword() {
        const currentPassword = document.getElementById('current-password').value;
        
        if (!currentPassword) {
            alert('Please enter your current password');
            return;
        }
        
        // In a real app, you would verify with the server
        // For demo, we'll simulate a successful verification
        document.getElementById('new-password').disabled = false;
        document.getElementById('confirm-password').disabled = false;
        document.getElementById('verify-password-btn').style.display = 'none';
        document.getElementById('change-password-btn').style.display = 'block';
        
        alert('Password verified! You can now set a new password.');
    }
    
    // Function to change password
    function changePassword() {
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        
        if (!newPassword) {
            alert('Please enter a new password');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            alert('New passwords do not match');
            return;
        }
        
        // In a real app, you would send this data to the server
        // For demo purposes, show success message
        alert('Password updated successfully!');
        closeModal('change-password-modal');
        
        // Reset the form for next time
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        document.getElementById('new-password').disabled = true;
        document.getElementById('confirm-password').disabled = true;
        document.getElementById('verify-password-btn').style.display = 'block';
        document.getElementById('change-password-btn').style.display = 'none';
    }
    
    // Function to delete account
    function deleteAccount() {
        const password = document.getElementById('delete-password').value;
        
        if (!password) {
            alert('Please enter your password to confirm account deletion');
            return;
        }
        
        // In a real app, you would send this data to the server
        // For demo purposes, log out the user
        sessionStorage.removeItem('isLoggedIn');
        localStorage.removeItem('isLoggedIn');
        sessionStorage.removeItem('username');
        localStorage.removeItem('username');
        sessionStorage.removeItem('email');
        localStorage.removeItem('email');
        sessionStorage.removeItem('profilePic');
        localStorage.removeItem('profilePic');
        
        alert('Your account has been deleted. You will be logged out.');
        window.location.href = 'logout.html';
    }
    
    // Allow editing of username in profile modal
    document.getElementById('display-username').addEventListener('change', function() {
        const newUsername = this.value;
        document.getElementById('sidebar-username').textContent = newUsername;
        
        // Store in session and local storage
        sessionStorage.setItem('username', newUsername);
        localStorage.setItem('username', newUsername);
        
        // Also update fullname in settings if opened later
        if (document.getElementById('fullname')) {
            document.getElementById('fullname').value = newUsername;
        }
    });
</script>

<script>
    // Check if user is logged in and update UI accordingly
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user is logged in (either via Flask session or local storage)
        const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true' || localStorage.getItem('isLoggedIn') === 'true';
        
        if (isLoggedIn) {
            // Hide login/signup buttons
            document.getElementById('signup-link').style.display = 'none';
            document.getElementById('login-link').style.display = 'none';
            
            // Show profile icon
            const profileIcon = document.getElementById('profile-icon');
            profileIcon.style.display = 'block';
            
            // Set user data in sidebar and profile modal
            const username = sessionStorage.getItem('username') || localStorage.getItem('username') || 'User';
            const profilePic = sessionStorage.getItem('profilePic') || localStorage.getItem('profilePic');
            const email = sessionStorage.getItem('email') || localStorage.getItem('email') || 'user@example.com';
            const joinedDate = sessionStorage.getItem('joinedDate') || localStorage.getItem('joinedDate') || 'January 2025';
            
            // Set username in sidebar and profile
            document.getElementById('sidebar-username').textContent = username;
            document.getElementById('display-username').value = username;
            document.getElementById('joined-date').value = joinedDate;
            document.getElementById('member-since').textContent = joinedDate;
            
            if (document.getElementById('fullname')) {
                document.getElementById('fullname').value = username;
            }
            
            if (document.getElementById('email')) {
                document.getElementById('email').value = email;
            }
            
            // Set profile picture if available
            if (profilePic && profilePic !== '') {
                const picUrl = profilePic.startsWith('http') ? profilePic : '/uploads/' + profilePic;
                document.getElementById('sidebar-avatar').style.backgroundImage = `url('${picUrl}')`;
                document.getElementById('current-profile-pic').src = picUrl;
                profileIcon.style.backgroundImage = `url('${picUrl}')`;
            }
        }
        
        // Set current year in footer
        document.getElementById('footer-year').textContent = new Date().getFullYear();
    });
    
    // Sidebar toggle functions
    function toggleSidebar() {
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('overlay').classList.add('active');
    }
    
    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('overlay').classList.remove('active');
    }
    
    // Modal functions
    function openModal(modalId) {
        closeSidebar();
        document.getElementById(modalId).classList.add('modal-active');
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('modal-active');
    }
    
    // Chatbot toggle
    document.getElementById('chatbot-toggle').addEventListener('click', function() {
        const chatbotBox = document.getElementById('chatbot-box');
        if (chatbotBox.style.display === 'block') {
            chatbotBox.style.display = 'none';
        } else {
            chatbotBox.style.display = 'block';
            document.getElementById('chatbot-input').focus();
        }
    });
    
    // Chatbot send message
    document.getElementById('chatbot-send').addEventListener('click', sendChatMessage);
    document.getElementById('chatbot-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
    
    function sendChatMessage() {
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const message = chatbotInput.value.trim();
        
        if (message === '') return;
        
        // Add user message
        chatbotMessages.innerHTML += `<p><strong>You:</strong> ${message}</p>`;
        chatbotInput.value = '';
        
        // Scroll to bottom
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        
        // Send message to backend and get response
        fetch('/ask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question: message }),
        })
        .then(response => response.json())
        .then(data => {
            chatbotMessages.innerHTML += `<p><strong>Enomy Bot:</strong> ${data.answer}</p>`;
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        })
        .catch(error => {
            console.error('Error:', error);
            chatbotMessages.innerHTML += `<p><strong>Enomy Bot:</strong> Sorry, I'm having trouble connecting right now. Please try again later.</p>`;
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        });
    }
    
    // Profile picture preview
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                document.getElementById('current-profile-pic').src = e.target.result;
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    // Profile form submission - modified to handle the profile picture upload
    document.getElementById('profile-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/upload-profile-pic', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update profile pictures throughout the interface
                const picUrl = data.imageUrl;
                document.getElementById('profile-icon').style.backgroundImage = `url('${picUrl}')`;
                document.getElementById('sidebar-avatar').style.backgroundImage = `url('${picUrl}')`;
                
                // Store in session and local storage
                sessionStorage.setItem('profilePic', picUrl);
                localStorage.setItem('profilePic', picUrl);
                
                alert('Profile picture updated successfully!');
                closeModal('profile-modal');
            } else {
                alert('Error updating profile picture: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating your profile picture.');
        });
    });
    
    // Function to save settings
    function saveSettings() {
        const fullname = document.getElementById('fullname').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const location = document.getElementById('location').value;
        
        // Store in session and local storage
        sessionStorage.setItem('username', fullname);
        localStorage.setItem('username', fullname);
        sessionStorage.setItem('email', email);
        localStorage.setItem('email', email);
        
        // Update UI elements
        document.getElementById('sidebar-username').textContent = fullname;
        document.getElementById('display-username').value = fullname;
        
        // In a real app, you would send this data to the server
        // For demo purposes, show success message
        alert('Settings saved successfully!');
        closeModal('settings-modal');
    }
    
    // Toggle password visibility
    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.nextElementSibling;
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
    
    // Function to verify current password
    function verifyCurrentPassword() {
        const currentPassword = document.getElementById('current-password').value;
        
        if (!currentPassword) {
            alert('Please enter your current password');
            return;
        }
        
        // In a real app, you would verify with the server
        // For demo, we'll simulate a successful verification
        document.getElementById('new-password').disabled = false;
        document.getElementById('confirm-password').disabled = false;
        document.getElementById('verify-password-btn').style.display = 'none';
        document.getElementById('change-password-btn').style.display = 'block';
        
        alert('Password verified! You can now set a new password.');
    }
    
    // Function to change password
    function changePassword() {
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        
        if (!newPassword) {
            alert('Please enter a new password');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            alert('New passwords do not match');
            return;
        }
        
        // In a real app, you would send this data to the server
        // For demo purposes, show success message
        alert('Password updated successfully!');
        closeModal('change-password-modal');
        
        // Reset the form for next time
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        document.getElementById('new-password').disabled = true;
        document.getElementById('confirm-password').disabled = true;
        document.getElementById('verify-password-btn').style.display = 'block';
        document.getElementById('change-password-btn').style.display = 'none';
    }
    
    // Function to delete account
    function deleteAccount() {
        const password = document.getElementById('delete-password').value;
        
        if (!password) {
            alert('Please enter your password to confirm account deletion');
            return;
        }
        
        // In a real app, you would send this data to the server
        // For demo purposes, log out the user
        sessionStorage.removeItem('isLoggedIn');
        localStorage.removeItem('isLoggedIn');
        sessionStorage.removeItem('username');
        localStorage.removeItem('username');
        sessionStorage.removeItem('email');
        localStorage.removeItem('email');
        sessionStorage.removeItem('profilePic');
        localStorage.removeItem('profilePic');
        
        alert('Your account has been deleted. You will be logged out.');
        window.location.href = 'logout.html';
    }
    
    // Allow editing of username in profile modal
    document.getElementById('display-username').addEventListener('change', function() {
        const newUsername = this.value;
        document.getElementById('sidebar-username').textContent = newUsername;
        
        // Store in session and local storage
        sessionStorage.setItem('username', newUsername);
        localStorage.setItem('username', newUsername);
        
        // Also update fullname in settings if opened later
        if (document.getElementById('fullname')) {
            document.getElementById('fullname').value = newUsername;
        }
    });
</script>